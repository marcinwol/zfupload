<div>

    <?php echo $this->form; ?>

    <script type="text/javascript">   
        // make the form nicer
	$("input").uniform();
        
        // when form is submitted, execut monitorUpload function
        $("#files-upload-form").bind('submit', function () {
            
            var filesSelected = false;
            
            // monitor upload progress only when some files were selected for upload
            // not only when submit button was clicked
            $('input[type=file]').each(function(){                
                if ($(this).val()) {       
                    filesSelected = true;                    
                }                
            });
            
            if (filesSelected) {
                monitorUpload();
            }
        });
                   
        
        function monitorUpload() {            
                    
            // get the pregoress_key which is automatically generated by Zend_Form_Element_File
            // and avaliable in the form as a hidden element with id="progress_key"
            // This progress_key is required by uploadprogress_get_info function
            var progress_key = $("#progress_key").val(); 
        
        
            // indicatate which controller/action will be used to get upload progress data
            var progress_action = "<?php echo $this->baseUrl('/index/progress'); ?>";              
        
            // where should we go after successful upload
            var success_action  = "<?php echo $this->baseUrl('/index/success'); ?>";  
            
           
            // show progress bar
            $("#uploadprogressbar").fadeIn();         


            // make repeated AJAX requests to 'progress_action'
            // to get current status of upload progress
            // Dont forget to sent a progress_key with each AJAX request
            var i = setInterval(function() { 
                $.ajax({
                    url:  progress_action + "/id/" + progress_key,
                    type: 'GET',
                    dataType: 'json',
                    success: function(data) {
                        
                        // when upload finishes than stop AJAX calls 
                        // and redirect index/success action
                        if (true == data.finished) {
                            clearInterval(i);
                            $("#uploadprogressbar").progressBar(100);                          
                            return;
                        }
                  
                        // update progress bar with current percentage
                        $("#uploadprogressbar").progressBar(data.percent);
                    },
                    error: function() { 
                        // do nothing 
                    }
                });
            return;    
            }, 1000);
        }
        
        
    </script>
</script>
<div>
    <!-- here the progress bar is going to be shown -->
    <span class="progressbar" id="uploadprogressbar" style>0%</span>	
</div>
<script type="text/javascript">    

    // set base path for progressBar images
    var image_base_path = '<?php echo $this->baseUrl(); ?>';
    
    $("#uploadprogressbar").progressBar({
        boxImage: image_base_path + '/images/progressbar.gif',
        barImage: {
            0:	image_base_path + '/images/progressbg_red.gif',
            30: image_base_path + '/images/progressbg_orange.gif',
            70: image_base_path + '/images/progressbg_green.gif'
        }
    }
);
</script>

<!-- Ok, you so need this iframe for Safari and Chrome to work, 
the webkit engine doesnt allow ajax calls to be made after 
a form begins submission -->
<iframe style="display: block;" name="progressFrame" id="progressiFrame"></iframe>
</div>
